<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Binance Level Bot — V3 (Şık UI + Tam Akış)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f1a; --panel:#0f1626; --panel2:#0c1322; --text:#eaf1ff; --muted:#9fb0ca;
    --accent:#6ca8ff; --good:#2bd97f; --warn:#ffcf5a; --bad:#ff6161; --line:#1a2540; --chip:#0e1a33;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 80% -10%,rgba(96,165,250,.1),transparent),radial-gradient(1000px 500px at -10% 0,rgba(43,217,127,.09),transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .app{max-width:1260px;margin:26px auto;padding:0 16px;display:grid;gap:16px;grid-template-rows:auto auto 1fr auto}
  header{display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:20px;letter-spacing:.3px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#8fe3ff)}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:linear-gradient(180deg,#0f1c36,#0b1326);border:1px solid #142347;border-radius:999px;color:#cfe1ff}
  .chip b{color:#fff}

  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel{padding:14px 16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:16px}
  .grid{display:grid;gap:16px}
  .btn{background:linear-gradient(180deg,var(--accent),#8ec3ff);color:#041021;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s transform}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:#1b2947;color:#cfe1ff}
  .btn.ghost{background:transparent;border:1px solid #24365f;color:#cfe1ff}
  .btn.bad{background:linear-gradient(180deg,#ff7b7b,#ff6161);color:#fff}
  .btn.warn{background:linear-gradient(180deg,#ffd36a,#ffbd3a);color:#1d1200}
  input,select{width:100%;background:#0a1324;border:1px solid #1f2b4d;color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
  label{font-size:12px;color:#9fb0ca;margin-bottom:6px;display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:9px 10px;border-bottom:1px solid #182447;font-size:14px}
  th{color:#a9bad6;text-align:left;font-weight:600}
  .right{justify-content:flex-end}
  .small{font-size:12px;color:#9fb0ca}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .status{padding:2px 8px;border-radius:999px;border:1px solid #203058;font-size:12px;color:#cfe1ff;background:#0c1833}
  .s-idle{background:#0c1833}
  .s-buying{background:#0f234d}
  .s-wait{background:#2b2408;color:#ffd36a}
  .s-selling{background:#0f3a2a;color:#bdf8d5}
  .s-done{background:#0e2b1f;color:#8cf0b4}
  .s-error{background:#331212;color:#ffb5b5}
  .scroll{max-height:280px;overflow:auto;border:1px solid #182447;border-radius:12px;background:#0a1324}
  .logline{padding:8px 10px;border-bottom:1px solid #122041;font-size:13px}
  .logline .ts{opacity:.7;margin-right:8px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .hint{background:#0b162c;border:1px dashed #22345f;padding:8px 10px;border-radius:12px}
  .divider{height:1px;background:#1a2540;margin:10px 0}
  .ok{color:var(--good)} .warnc{color:var(--warn)} .badc{color:var(--bad)}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand"><div class="dot"></div><h1>Binance Level Bot — <span class="small">V3</span></h1></div>
    <div class="kpis">
      <div class="chip">Durum: <b id="gStatus">Hazır</b></div>
      <div class="chip">Saat ofseti: <b id="gOffset">-</b></div>
      <div class="chip">Açık Emir: <b id="gOpen">0</b></div>
    </div>
  </header>

  <!-- Bağlantı Ayarları -->
  <section class="card panel">
    <div class="row">
      <div>
        <label>Proxy URL (Cloudflare Worker) — <span class="small">sonunda <span class="mono">/</span> olmasın</span></label>
        <input id="proxyUrl" placeholder="https://<senin-worker>.workers.dev" />
      </div>
      <div>
        <label>Binance Base URL (ops.)</label>
        <input id="baseUrl" placeholder="https://api.binance.com" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>API Key (opsiyonel — Workers Secrets kullanıyorsan boş bırak)</label>
        <input id="apiKey" placeholder="API Key" />
      </div>
      <div>
        <label>Secret Key (opsiyonel)</label>
        <input id="apiSecret" type="password" placeholder="Secret Key" />
      </div>
    </div>
    <div class="toolbar right" style="margin-top:12px">
      <button class="btn secondary" id="saveConn">Kaydet</button>
      <button class="btn" id="testConn">Bağlantıyı Test Et</button>
      <button class="btn ghost" id="syncTime" disabled>Saati Senkronize Et</button>
    </div>
    <div class="hint small" id="connNote" style="margin-top:10px">Önce Proxy URL yazıp <b>Kaydet</b> → sonra <b>Bağlantıyı Test Et</b>.</div>
  </section>

  <!-- Üçlü Kolon: Çiftler / Aktif Emirler / Bakiyeler -->
  <section class="row3">
    <!-- Çiftler -->
    <div class="card panel">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:6px">
        <div class="small"><b>Akış:</b> Alım = <span class="mono">BID N</span>, Dolunca Satış = <span class="mono">ASK M</span>. Miktar kurallara göre otomatik yuvarlanır.</div>
        <div class="toolbar">
          <button class="btn" id="addRow">+ Çift Ekle</button>
          <button class="btn warn" id="startAll">Başlat</button>
          <button class="btn bad" id="stopAll">Durdur</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Sembol</th>
            <th>Tutar/Miktar</th>
            <th>Mod</th>
            <th>BID N</th>
            <th>ASK M</th>
            <th>Durum</th>
            <th>Aksiyon</th>
          </tr>
        </thead>
        <tbody id="pairsBody"></tbody>
      </table>
    </div>

    <!-- Aktif Emirler -->
    <div class="card panel">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:6px">
        <div><b>Aktif Emirler</b></div>
        <div class="toolbar">
          <button class="btn secondary" id="refreshOpen">Yenile</button>
        </div>
      </div>
      <div class="scroll" id="openOrdersBox"></div>
    </div>

    <!-- Bakiyeler -->
    <div class="card panel">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:6px">
        <div><b>Bakiyeler</b></div>
        <div class="toolbar">
          <button class="btn secondary" id="refreshBalances">Yenile</button>
        </div>
      </div>
      <div id="balancesBox" class="small">Hesap bakiyeleri için Worker'da <span class="mono">/api/account</span> ucu tanımlı olmalı (koydum). Secret'ları eklediğinden emin ol.</div>
    </div>
  </section>

  <!-- Son İşlemler & Loglar -->
  <section class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card panel">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:6px">
        <div><b>Son İşlemler</b> <span class="small">(BUY/SELL fill)</span></div>
        <button class="btn secondary" id="clearHistory">Temizle</button>
      </div>
      <div class="scroll" id="historyBox"></div>
    </div>
    <div class="card panel">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:6px">
        <div><b>Canlı Log</b></div>
        <button class="btn secondary" id="clearLog">Temizle</button>
      </div>
      <div class="scroll" id="logBox"></div>
    </div>
  </section>

  <footer class="small">
    <div class="divider"></div>
    <div>İpucu: Proxy URL sonunda <span class="mono">/</span> olmasın. Önce küçük tutarlarla test et. Hata durumunda üstteki <b>Bağlantıyı Test Et</b> butonu hızlı teşhis yapar.</div>
  </footer>
</div>

<script>
// ======================== Durum / Depo ========================
const el = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat('tr-TR',{maximumFractionDigits:8}).format(Number(n||0));
const S = JSON.parse(localStorage.getItem('botV3')||'{}');
S.conn = S.conn || { proxyUrl:'', baseUrl:'', apiKey:'', apiSecret:'', timeOffsetMs:0 };
S.rows = S.rows || [ rowDefault('DYMUSDT') ];
S.orders = S.orders || [];      // botun açtığı emirler {orderId,symbol,side,qty,price,status}
S.history = S.history || [];    // {t,type,msg,extra}
S.logs = S.logs || [];
S.cache = S.cache || {};        // küçük bellek

function rowDefault(symbol){
  return { symbol:symbol||'BTCUSDT', mode:'QUOTE', amount:10, buyLevel:2, sellLevel:3, running:false, status:'idle', info:null, activeOrderId:null, buyFilledQty:null };
}
function save(){ localStorage.setItem('botV3', JSON.stringify(S)); }
function log(type,msg,data){ S.logs.push({t:Date.now(),type,msg,data:data||null}); if(S.logs.length>400) S.logs.shift(); save(); renderLog(); }
function hist(type,msg,extra){ S.history.unshift({t:Date.now(),type,msg,extra:extra||null}); if(S.history.length>200) S.history.pop(); save(); renderHistory(); }

// ======================== URL & Fetch Helpers ========================
function isValidUrl(u){ try{ const ok = /^https?:\/\//i.test(u); return !!ok; }catch(_){ return false; } }
function join(base, path){ const b=(base||'').replace(/\/+$/,''); const p=(path||'').replace(/^\/+/, ''); return b + '/' + p; }
function buildUrl(path, q){ let u = join(S.conn.proxyUrl, path); const params = new URLSearchParams(q||{}); if (S.conn.baseUrl) params.set('baseUrl', S.conn.baseUrl); const qs=params.toString(); if(qs) u += (u.includes('?')?'&':'?')+qs; return u; }
async function httpGet(path, q){ const url = buildUrl(path, q); const headers = {}; if(S.conn.apiKey) headers['X-API-KEY']=S.conn.apiKey; if(S.conn.apiSecret) headers['X-API-SECRET']=S.conn.apiSecret; const r = await fetch(url,{headers}); let js={}; try{ js=await r.json(); }catch{} if(!r.ok) throw new Error(js.message||js.msg||(`${r.status} ${r.statusText}`)); return js; }
async function httpPost(path, body){ const url = buildUrl(path); const headers={'Content-Type':'application/json'}; if(S.conn.apiKey) headers['X-API-KEY']=S.conn.apiKey; if(S.conn.apiSecret) headers['X-API-SECRET']=S.conn.apiSecret; const r = await fetch(url,{method:'POST',headers,body:JSON.stringify(body||{})}); let js={}; try{ js=await r.json(); }catch{} if(!r.ok) throw new Error(js.message||js.msg||(`${r.status} ${r.statusText}`)); return js; }

// ======================== Bağlantı UI ========================
function renderConn(){ el('proxyUrl').value=S.conn.proxyUrl||''; el('baseUrl').value=S.conn.baseUrl||''; el('apiKey').value=S.conn.apiKey||''; el('apiSecret').value=S.conn.apiSecret||''; el('gOffset').textContent=(S.conn.timeOffsetMs||0)+' ms'; }
function setStatus(s){ el('gStatus').textContent=s; }
function setOpenCount(){ const open=S.orders.filter(o=>!['FILLED','CANCELED','REJECTED','EXPIRED'].includes(o.status||'')); el('gOpen').textContent=open.length; }

el('saveConn').onclick = ()=>{ S.conn.proxyUrl=el('proxyUrl').value.trim(); S.conn.baseUrl=el('baseUrl').value.trim(); S.conn.apiKey=el('apiKey').value.trim(); S.conn.apiSecret=el('apiSecret').value.trim(); save(); renderConn(); el('connNote').textContent='Kaydedildi. Şimdi Bağlantıyı Test Et'; log('info','Connection saved',{proxy:S.conn.proxyUrl}); };

el('testConn').onclick = async ()=>{
  try{
    if(!isValidUrl(S.conn.proxyUrl)) throw new Error('Proxy URL geçersiz. https:// ile başlamalı ve sonunda / olmamalı.');
    el('connNote').textContent='Test ediliyor...';
    // 1) /api/time
    const t = await httpGet('/api/time');
    if(!t || !t.serverTime) throw new Error('/api/time başarısız');
    // 2) /api/exchangeInfo
    const ex = await httpGet('/api/exchangeInfo', {symbol:'BTCUSDT'});
    if(!ex || !ex.symbols || !ex.symbols.length) throw new Error('/api/exchangeInfo başarısız');
    el('connNote').innerHTML = `<span class='ok'>Bağlantı OK</span> — <span class='mono'>/api/time</span> ve <span class='mono'>/api/exchangeInfo</span> çalışıyor.`;
    el('syncTime').disabled=false;
    log('info','Connection test OK');
  }catch(e){ el('connNote').innerHTML = `<span class='badc'>Hata:</span> ${e.message}`; el('syncTime').disabled=true; log('warn','Connection test failed',{error:e.message}); }
};

el('syncTime').onclick = async ()=>{
  try{ const t0=Date.now(); const data = await httpGet('/api/time'); const t1=Date.now(); const approx=(t0+t1)/2; S.conn.timeOffsetMs=Math.round((data.serverTime||approx)-approx); save(); renderConn(); log('info','Time synced',{offset:S.conn.timeOffsetMs}); }
  catch(e){ S.conn.timeOffsetMs=0; save(); renderConn(); log('warn','Time sync failed',{error:e.message}); }
};

// ======================== Çiftler Tablosu ========================
function renderRows(){ const body=el('pairsBody'); body.innerHTML=''; S.rows.forEach((row,idx)=> addRowUI(row,idx)); }
function addRowUI(row,idx){
  const tr=document.createElement('tr');
  // Sembol
  const tdS=document.createElement('td'); const iS=document.createElement('input'); iS.value=row.symbol; iS.onchange=()=>{row.symbol=iS.value.trim().toUpperCase(); save();}; tdS.appendChild(iS);
  // Tutar/Miktar
  const tdA=document.createElement('td'); const iA=document.createElement('input'); iA.type='number'; iA.step='any'; iA.value=row.amount; iA.onchange=()=>{row.amount=parseFloat(iA.value)||0; save();}; tdA.appendChild(iA);
  // Mod
  const tdM=document.createElement('td'); const sel=document.createElement('select'); sel.innerHTML='<option value="QUOTE">QUOTE(USDT)</option><option value="BASE">BASE(Miktar)</option>'; sel.value=row.mode; sel.onchange=()=>{row.mode=sel.value; save();}; tdM.appendChild(sel);
  // BID N
  const tdB=document.createElement('td'); const iB=document.createElement('input'); iB.type='number'; iB.min='1'; iB.value=row.buyLevel; iB.onchange=()=>{row.buyLevel=parseInt(iB.value)||1; save();}; tdB.appendChild(iB);
  // ASK M
  const tdSM=document.createElement('td'); const iSM=document.createElement('input'); iSM.type='number'; iSM.min='1'; iSM.value=row.sellLevel; iSM.onchange=()=>{row.sellLevel=parseInt(iSM.value)||1; save();}; tdSM.appendChild(iSM);
  // Durum
  const tdSt=document.createElement('td'); const chip=document.createElement('span'); chip.className='status s-'+row.status; chip.textContent=row.status; tdSt.appendChild(chip);
  // Aksiyonlar
  const tdAct=document.createElement('td');
  const bStart=document.createElement('button'); bStart.className='btn'; bStart.textContent='Başlat'; bStart.onclick=()=>startRow(idx,chip);
  const bStop=document.createElement('button'); bStop.className='btn secondary'; bStop.style.marginLeft='6px'; bStop.textContent='Durdur'; bStop.onclick=()=>stopRow(idx,chip);
  const bDel=document.createElement('button'); bDel.className='btn bad'; bDel.style.marginLeft='6px'; bDel.textContent='Sil'; bDel.onclick=()=>{ S.rows.splice(idx,1); save(); renderRows(); };
  tdAct.append(bStart,bStop,bDel);
  tr.append(tdS,tdA,tdM,tdB,tdSM,tdSt,tdAct); el('pairsBody').appendChild(tr);
}

el('addRow').onclick=()=>{ S.rows.push(rowDefault('BTCUSDT')); save(); renderRows(); };
el('startAll').onclick=()=> S.rows.forEach((_,i)=> startRow(i));
el('stopAll').onclick =()=> S.rows.forEach((_,i)=> stopRow(i));

// ======================== Emir Akışı ========================
function decFromStep(step){ const s=(step+"").split('.')[1]||''; return s.length; }
function floorToStep(v, step){ step=parseFloat(step); return Math.floor((v+1e-12)/step)*step; }
function roundTick(p, tick){ const d=decFromStep(tick); const m=Math.pow(10,d); return Math.floor(p*m+1e-9)/m; }

async function ensureInfo(row){ if(row.info) return; const ex=await httpGet('/api/exchangeInfo',{symbol:row.symbol}); const sym=ex.symbols && ex.symbols[0]; if(!sym) throw new Error('exchangeInfo yok: '+row.symbol); const pf=sym.filters.find(f=>f.filterType==='PRICE_FILTER'); const lf=sym.filters.find(f=>f.filterType==='LOT_SIZE') || sym.filters.find(f=>f.filterType==='MARKET_LOT_SIZE'); const mn=sym.filters.find(f=>f.filterType==='MIN_NOTIONAL'); row.info={ tickSize: pf?pf.tickSize:'0.0001', stepSize: lf?lf.stepSize:'0.0001', minQty: lf?parseFloat(lf.minQty):0, minNotional: mn?parseFloat(mn.minNotional):0 }; save(); }

const loops=new Map();
function setChip(chip,row,s){ row.status=s; chip.className='status s-'+s; chip.textContent=s; save(); }
async function cycle(idx, chip){ const row=S.rows[idx]; try{
  await ensureInfo(row);
  const lim=Math.max(row.buyLevel,row.sellLevel);
  const depth=await httpGet('/api/depth',{symbol:row.symbol,limit:lim});
  const bids=depth.bids||[], asks=depth.asks||[]; if(bids.length<row.buyLevel||asks.length<row.sellLevel) throw new Error('Derinlik yetersiz');
  const buyPx=parseFloat(bids[row.buyLevel-1][0]); const sellSnap=parseFloat(asks[row.sellLevel-1][0]);
  let qty=(row.mode==='QUOTE')?(row.amount/buyPx):row.amount; qty=Math.max(qty,row.info.minQty||0); qty=floorToStep(qty,row.info.stepSize); const px=roundTick(buyPx,row.info.tickSize);
  if(px*qty < (row.info.minNotional||0)) qty=floorToStep((row.info.minNotional+1e-9)/px,row.info.stepSize);
  if(!qty||qty<=0) throw new Error('Miktar 0 — min kuralları');

  setChip(chip,row,'buying');
  const buy=await httpPost('/trade/order',{symbol:row.symbol,side:'BUY',type:'LIMIT',timeInForce:'GTC',quantity:String(qty),price:String(px),clientOrderId:'L'+Date.now()});
  const buyOrder={createdAt:Date.now(),orderId:buy.orderId,symbol:row.symbol,side:'BUY',qty,price:px,status:buy.status||'NEW'}; S.orders.push(buyOrder); save(); setOpenCount(); renderOpenOrders(); log('info','BUY placed',buyOrder);

  setChip(chip,row,'wait');
  let filled=0; for(let i=0;i<200;i++){ await new Promise(r=>setTimeout(r,900)); const st=await httpGet('/trade/order/status',{symbol:row.symbol,orderId:buy.orderId}); buyOrder.status=st.status; save(); setOpenCount(); renderOpenOrders(); if(st.status==='FILLED'){ filled=parseFloat(st.executedQty); break; } if(['CANCELED','REJECTED','EXPIRED'].includes(st.status)) throw new Error('BUY başarısız: '+st.status); }
  if(!filled) throw new Error('Zaman aşımı: BUY dolmadı');
  row.buyFilledQty=floorToStep(filled,row.info.stepSize); hist('BUY FILLED',`${row.symbol} ${fmt(row.buyFilledQty)} @ ${fmt(px)}`);

  setChip(chip,row,'selling'); const sellPx=roundTick(sellSnap,row.info.tickSize);
  const sell=await httpPost('/trade/order',{symbol:row.symbol,side:'SELL',type:'LIMIT',timeInForce:'GTC',quantity:String(row.buyFilledQty),price:String(sellPx),clientOrderId:'S'+Date.now()});
  const sellOrder={createdAt:Date.now(),orderId:sell.orderId,symbol:row.symbol,side:'SELL',qty:row.buyFilledQty,price:sellPx,status:sell.status||'NEW'}; S.orders.push(sellOrder); save(); setOpenCount(); renderOpenOrders(); log('info','SELL placed',sellOrder);

  setChip(chip,row,'done'); renderHistory();
} catch(e){ setChip(chip,row,'error'); log('error','cycle failed: '+e.message); } finally { save(); } }

function startRow(idx, chip){ const row=S.rows[idx]; if(row.running) return; row.running=true; save(); setStatus('Çalışıyor'); const loop=async()=>{ if(!row.running) return; setChip(chip,row,'idle'); await cycle(idx,chip); if(!row.running) return; setTimeout(loop,1200); }; loops.set(idx,true); loop(); }
function stopRow(idx, chip){ const row=S.rows[idx]; row.running=false; setChip(chip,row,'idle'); save(); loops.delete(idx); if(loops.size===0) setStatus('Hazır'); }

// Açık emirleri periyodik güncelle (ve SELL fill tespiti)
setInterval(async()=>{ try{ const opened = await httpGet('/trade/openOrders'); const box=el('openOrdersBox'); if(Array.isArray(opened)){ S.orders = mergeOrders(S.orders, opened); save(); setOpenCount(); renderOpenOrders(); } }catch(_){ /* proxy desteklemeyebilir */ } }, 4000);

function mergeOrders(local, remote){ // remote (resmi) veriyi local kayıtlara yedir
  const map=new Map(local.map(o=>[String(o.orderId)+'_'+o.symbol,o]));
  for(const r of remote){ const key=String(r.orderId)+'_'+r.symbol; const cur=map.get(key)||{}; map.set(key,{ ...cur, ...r }); }
  return [...map.values()].sort((a,b)=> (a.updateTime||a.time||0)-(b.updateTime||b.time||0));
}

// ======================== Paneller ========================
function renderOpenOrders(){ const box=el('openOrdersBox'); box.innerHTML=''; if(!S.orders.length){ box.innerHTML='<div class="small" style="padding:10px">Açık emir yok</div>'; return; } for(const o of S.orders){ const div=document.createElement('div'); div.className='logline'; div.innerHTML=`<span class='ts'>${new Date(o.time||o.transactTime||o.createdAt||Date.now()).toLocaleTimeString('tr-TR',{hour12:false})}</span> <span class='mono'>${o.symbol}</span> <span class='chip'>${o.side||'-'}</span> <span class='mono'>${fmt(o.origQty||o.qty||o.executedQty||0)} @ ${fmt(o.price||0)}</span> <span class='status'>${o.status||'NEW'}</span> ${o.orderId?`<span class='small'>#${o.orderId}</span>`:''}`; box.appendChild(div); } }

async function refreshBalances(){ const box=el('balancesBox'); try{ const acc=await httpGet('/api/account'); const rows=(acc.balances||[]).filter(b=>parseFloat(b.free)>0 || parseFloat(b.locked)>0); if(!rows.length){ box.innerHTML='<div class="small">Hesapta bakiye görünmüyor.</div>'; return; } box.innerHTML = rows.map(b=> `${b.asset}: <span class='mono'>${fmt(b.free)}</span> (free) — <span class='mono'>${fmt(b.locked)}</span> (locked)`).join('<br>'); log('info','Balances updated',{count:rows.length}); }catch(e){ box.innerHTML=`<span class='warnc'>Proxy /api/account desteklemiyor veya Secret eksik.</span>`; log('warn','Balances failed',{error:e.message}); } }

function renderHistory(){ const box=el('historyBox'); box.innerHTML=''; for(const h of S.history){ const div=document.createElement('div'); div.className='logline'; div.innerHTML=`<span class='ts'>${new Date(h.t).toLocaleTimeString('tr-TR',{hour12:false})}</span> <b>${h.type}</b> — ${h.msg} ${h.extra?`<div class='small mono'>${JSON.stringify(h.extra)}</div>`:''}`; box.appendChild(div); } }

function renderLog(){ const box=el('logBox'); box.innerHTML=''; for(const ln of S.logs.slice(-250)){ const div=document.createElement('div'); div.className='logline'; div.innerHTML=`<span class='ts'>${new Date(ln.t).toLocaleTimeString('tr-TR',{hour12:false})}</span> <span class='status'>${ln.type}</span> ${ln.msg} ${ln.data?`<div class='small mono'>${JSON.stringify(ln.data)}</div>`:''}`; box.appendChild(div); } box.scrollTop=box.scrollHeight; }

// ======================== İlk yükleme ========================
function init(){ renderConn(); renderRows(); renderOpenOrders(); renderHistory(); renderLog(); }
init();

// Butonlar
el('refreshOpen').onclick = ()=> renderOpenOrders();
el('refreshBalances').onclick = ()=> refreshBalances();
el('clearHistory').onclick = ()=>{ S.history=[]; save(); renderHistory(); };
el('clearLog').onclick = ()=>{ S.logs=[]; save(); renderLog(); };

</script>
</body>
</html>
