<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Binance Seviye Botu — Tek Dosya</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --panel:#111a2b; --panel2:#0f1626; --text:#e6edf6;
    --muted:#9fb0ca; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  header h1{font-size:20px;margin:0}
  .card{background:linear-gradient(180deg,#111a2b,#0d1627);border:1px solid #19233a;border-radius:16px;box-shadow:0 0 0 1px #0b1220 inset}
  .panel{padding:14px 16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid{display:grid;gap:12px}
  .btn{background:var(--accent);color:#031020;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#1f2a44;color:#cfe1ff}
  .btn.warn{background:var(--warn);color:#0d0d0d}
  .btn.bad{background:var(--bad);color:#fff}
  input,select{width:100%;background:#0b1425;border:1px solid #1e2a44;color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
  label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #18213a;font-size:14px}
  th{color:#a9bad6;text-align:left}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0f1b31;color:#9fb0ca}
  .status-idle{color:#9fb0ca}
  .status-buying{color:#c3f0ff}
  .status-wait{color:#f6c76b}
  .status-selling{color:#bde5b8}
  .status-done{color:#8ef072}
  .status-error{color:#ffb4b4}
  .flex{display:flex;gap:8px;align-items:center}
  .right{justify-content:flex-end}
  .small{font-size:12px;color:#9fb0ca}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0b1425;padding:2px 6px;border-radius:6px;border:1px solid #1e2a44}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>🛠️ Binance Seviye Botu</h1>
    <div class="pill">Durum: <span id="globalStatus">Hazır</span></div>
  </header>

  <!-- Proxy + API Key Bölümü -->
  <div class="card panel">
    <div class="row">
      <div>
        <label>Proxy URL (Cloudflare Worker)</label>
        <input id="proxyUrl" placeholder="https://<senin-worker>.workers.dev" />
      </div>
      <div>
        <label>Binance Base URL (opsiyonel)</label>
        <input id="baseUrl" placeholder="https://api.binance.com (boş bırakırsan Worker default)" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>API Key (opsiyonel - Workers’ta secret kullanıyorsan boş bırak)</label>
        <input id="apiKey" placeholder="API Key" />
      </div>
      <div>
        <label>Secret Key (opsiyonel - gizli tutulur, istek başına Worker’a gider)</label>
        <input id="apiSecret" type="password" placeholder="Secret Key" />
      </div>
    </div>
    <div class="flex right" style="margin-top:12px">
      <button class="btn secondary" id="saveConn">Bağlantıyı Kaydet</button>
      <button class="btn" id="syncTime">Sunucu Saati Senkronize</button>
    </div>
    <div class="small" id="connNote" style="margin-top:8px"></div>
  </div>

  <!-- Bot Tablosu -->
  <div class="card panel" style="margin-top:16px">
    <div class="flex" style="justify-content:space-between; margin-bottom:10px">
      <div class="small">
        <strong>Çalışma Mantığı:</strong> ALIM = <span class="kbd">BID</span> tarafı N. sıra (pasif). FILL olunca SATIŞ = <span class="kbd">ASK</span> tarafı M. sıra. Miktar=alınan kadar. Kurallara uygun şekilde yuvarlama yapılır.
      </div>
      <button class="btn" id="addRow">+ Çift Ekle</button>
    </div>

    <table id="pairsTable">
      <thead>
        <tr>
          <th>Sembol</th>
          <th>Harcanacak (USDT) veya Miktar</th>
          <th>Mod</th>
          <th>ALIM Seviye (BID N)</th>
          <th>SATIŞ Seviye (ASK M)</th>
          <th>Durum</th>
          <th>Aksiyon</th>
        </tr>
      </thead>
      <tbody id="pairsBody"></tbody>
    </table>

    <div class="flex right" style="margin-top:12px">
      <button class="btn warn" id="startAll">Başlat</button>
      <button class="btn bad" id="stopAll">Durdur</button>
    </div>
  </div>

  <div class="small" style="margin-top:12px">
    <strong>Notlar:</strong> Gerçek emir atar. Önce çok küçük miktarlarla test et. Zaman senkronu ve adım/lot kurallarına uyum kritik. Binance REST imza ve `X-MBX-APIKEY` başlığı zorunludur (SIGNED uçlar). :contentReference[oaicite:3]{index=3}
  </div>
</div>

<script>
/** ====== Basit Durum ve Depo ====== **/
const el = id => document.getElementById(id);
const S = JSON.parse(localStorage.getItem('botState') || '{}');
function save(){ localStorage.setItem('botState', JSON.stringify(S)); }

const defaultRow = () => ({
  symbol: 'DYMUSDT',
  mode: 'QUOTE',           // QUOTE: USDT harca, BASE: sabit coin miktarı
  amount: 10,              // QUOTE ise USDT, BASE ise adet
  buyLevel: 2,
  sellLevel: 3,
  running: false,
  status: 'idle',
  info: null,              // exchangeInfo'dan filtreler
  activeOrderId: null,
  buyFilledQty: null
});

S.conn = S.conn || { proxyUrl:'', baseUrl:'', apiKey:'', apiSecret:'', timeOffsetMs:0 };
S.rows = S.rows || [ defaultRow() ];
save();

/** ====== UI Bağlama ====== **/
function renderConn(){
  el('proxyUrl').value = S.conn.proxyUrl || '';
  el('baseUrl').value = S.conn.baseUrl || '';
  el('apiKey').value = S.conn.apiKey || '';
  el('apiSecret').value = S.conn.apiSecret || '';
  el('connNote').textContent = S.conn.timeOffsetMs ? ('Sunucu saat ofseti: '+S.conn.timeOffsetMs+' ms') : 'Saat senkronu yapılmadı.';
}
renderConn();

el('saveConn').onclick = ()=>{
  S.conn.proxyUrl = el('proxyUrl').value.trim();
  S.conn.baseUrl = el('baseUrl').value.trim();
  S.conn.apiKey = el('apiKey').value.trim();
  S.conn.apiSecret = el('apiSecret').value.trim();
  save();
  el('connNote').textContent = 'Kaydedildi.';
};

el('syncTime').onclick = async ()=>{
  try{
    const t0 = Date.now();
    const r = await fetch(S.conn.proxyUrl+'/api/time');
    const js = await r.json();
    const t1 = Date.now();
    const server = js.serverTime;
    // Ağ gecikmesini kabaca düş: RTT/2
    const approxNow = (t0 + t1)/2;
    S.conn.timeOffsetMs = server - approxNow;
    save();
    el('connNote').textContent = 'Sunucu saat ofseti ≈ '+S.conn.timeOffsetMs+' ms';
  }catch(e){
    el('connNote').textContent = 'Saat senkron hatası: '+e.message;
  }
};

function addRowUI(row, idx){
  const tr = document.createElement('tr');

  const sym = document.createElement('td');
  const symIn = document.createElement('input');
  symIn.value = row.symbol;
  symIn.onchange = ()=>{ row.symbol = symIn.value.trim().toUpperCase(); save(); };
  sym.appendChild(symIn);

  const amt = document.createElement('td');
  const amtIn = document.createElement('input');
  amtIn.type='number'; amtIn.step='any'; amtIn.value = row.amount;
  amtIn.onchange = ()=>{ row.amount = parseFloat(amtIn.value)||0; save(); };
  amt.appendChild(amtIn);

  const mode = document.createElement('td');
  const sel = document.createElement('select');
  sel.innerHTML = '<option value="QUOTE">QUOTE(USDT)</option><option value="BASE">BASE(Miktar)</option>';
  sel.value = row.mode;
  sel.onchange = ()=>{ row.mode = sel.value; save(); };
  mode.appendChild(sel);

  const buy = document.createElement('td');
  const buyIn = document.createElement('input'); buyIn.type='number'; buyIn.min='1'; buyIn.value=row.buyLevel;
  buyIn.onchange = ()=>{ row.buyLevel = parseInt(buyIn.value)||1; save(); };
  buy.appendChild(buyIn);

  const sell = document.createElement('td');
  const sellIn = document.createElement('input'); sellIn.type='number'; sellIn.min='1'; sellIn.value=row.sellLevel;
  sellIn.onchange = ()=>{ row.sellLevel = parseInt(sellIn.value)||1; save(); };
  sell.appendChild(sellIn);

  const stat = document.createElement('td');
  const statSpan = document.createElement('span');
  function paint(){
    statSpan.className = 'status-'+row.status;
    statSpan.textContent = row.status;
  }
  paint();
  stat.appendChild(statSpan);

  const act = document.createElement('td');
  const startBtn = document.createElement('button'); startBtn.className='btn'; startBtn.textContent='Başlat';
  const stopBtn = document.createElement('button'); stopBtn.className='btn secondary'; stopBtn.textContent='Durdur'; stopBtn.style.marginLeft='6px';
  startBtn.onclick = ()=> startRow(idx, statSpan);
  stopBtn.onclick = ()=> stopRow(idx, statSpan);
  act.appendChild(startBtn); act.appendChild(stopBtn);

  tr.append(sym,amt,mode,buy,sell,stat,act);
  el('pairsBody').appendChild(tr);
}

function renderRows(){
  el('pairsBody').innerHTML='';
  S.rows.forEach((row,idx)=> addRowUI(row, idx));
}
renderRows();

el('addRow').onclick = ()=>{
  S.rows.push(defaultRow());
  save(); renderRows();
};
el('startAll').onclick = ()=> S.rows.forEach((_,i)=> startRow(i));
el('stopAll').onclick = ()=> S.rows.forEach((_,i)=> stopRow(i));

/** ====== Yardımcılar: filtreler ve yuvarlama ====== **/
function decimalsFromStep(stepStr){
  const s = stepStr.indexOf('.')>=0 ? stepStr.split('.')[1] : '';
  return (s.replace(/0+$/,'').length) || (s.length); // 0.010000 -> 2
}
function floorToStep(v, stepStr){
  const d = decimalsFromStep(stepStr);
  const m = Math.pow(10,d);
  return (Math.floor((v + 1e-12) * m / Math.round(parseFloat(stepStr)*m)) * Math.round(parseFloat(stepStr)*m)) / m;
}
function roundPriceToTick(p, tickStr){
  const d = decimalsFromStep(tickStr);
  const m = Math.pow(10,d);
  return Math.floor(p * m + 1e-9) / m;
}

/** ====== Proxy’ye çağrılar ====== **/
async function proxyGET(path){
  const u = new URL(S.conn.proxyUrl + path);
  if (S.conn.baseUrl) u.searchParams.set('baseUrl', S.conn.baseUrl);
  const r = await fetch(u, { headers: { 'X-API-KEY': S.conn.apiKey||'', 'X-API-SECRET': S.conn.apiSecret||'' } });
  const js = await r.json();
  if (!r.ok) throw new Error(js.message || r.statusText);
  return js;
}
async function proxyPOST(path, body){
  const u = new URL(S.conn.proxyUrl + path);
  if (S.conn.baseUrl) u.searchParams.set('baseUrl', S.conn.baseUrl);
  const headers = { 'Content-Type':'application/json' };
  if (S.conn.apiKey) headers['X-API-KEY'] = S.conn.apiKey;
  if (S.conn.apiSecret) headers['X-API-SECRET'] = S.conn.apiSecret;
  const r = await fetch(u, { method:'POST', headers, body: JSON.stringify(body) });
  const js = await r.json().catch(()=> ({}));
  if (!r.ok) throw new Error(js.msg || js.message || r.statusText);
  return js;
}

/** ====== İş Akışı ====== **/
const timers = new Map();

async function ensureExchangeInfo(row){
  if (row.info) return;
  const js = await proxyGET('/api/exchangeInfo?symbol='+row.symbol);
  const sym = js.symbols && js.symbols[0];
  if (!sym) throw new Error('exchangeInfo bulunamadı: '+row.symbol);
  const pf = sym.filters.find(f=>f.filterType==='PRICE_FILTER');
  const lf = sym.filters.find(f=>f.filterType==='LOT_SIZE') || sym.filters.find(f=>f.filterType==='MARKET_LOT_SIZE');
  const mn = sym.filters.find(f=>f.filterType==='MIN_NOTIONAL');
  row.info = {
    tickSize: pf ? pf.tickSize : '0.0001',
    stepSize: lf ? lf.stepSize : '0.0001',
    minQty: lf ? parseFloat(lf.minQty) : 0,
    minNotional: mn ? parseFloat(mn.minNotional) : 0
  };
  save();
}

function setStatus(row, s, statSpan){
  row.status = s; save();
  if (statSpan){ statSpan.className='status-'+s; statSpan.textContent = s; }
}

async function oneCycle(idx, statSpan){
  const row = S.rows[idx];
  try{
    await ensureExchangeInfo(row);

    // 1) Orderbook çek
    const depth = await proxyGET('/api/depth?symbol='+row.symbol+'&limit='+Math.max(row.buyLevel, row.sellLevel));
    const bids = depth.bids || []; // [[price,qty],...]
    const asks = depth.asks || [];
    if (bids.length < row.buyLevel || asks.length < row.sellLevel) throw new Error('Derinlik yetersiz');

    const buyPrice = parseFloat(bids[row.buyLevel-1][0]); // BID N
    const sellPriceSnap = parseFloat(asks[row.sellLevel-1][0]); // ASK M (snap)

    // 2) Miktar hesapla
    let qty;
    if (row.mode==='QUOTE'){
      // USDT / buyPrice => base qty
      qty = row.amount / buyPrice;
    }else{
      qty = row.amount;
    }
    // lot & tick ve min kuralları
    qty = Math.max(qty, row.info.minQty || 0);
    qty = floorToStep(qty, row.info.stepSize);
    const priceRounded = roundPriceToTick(buyPrice, row.info.tickSize);
    if (priceRounded * qty < (row.info.minNotional||0)) {
      // min notional’a it
      qty = floorToStep((row.info.minNotional + 1e-9)/priceRounded, row.info.stepSize);
    }
    if (!qty || qty<=0) throw new Error('Miktar 0 — min kurallarına uymuyor');

    // 3) BUY LIMIT (GTC)
    setStatus(row,'buying', statSpan);
    const buyRes = await proxyPOST('/trade/order', {
      symbol: row.symbol, side:'BUY', type:'LIMIT', timeInForce:'GTC',
      quantity: qty.toString(), price: priceRounded.toString(),
      clientOrderId: 'L'+Date.now()
    });
    row.activeOrderId = buyRes.orderId;
    save();

    // 4) FILL bekle (poll)
    setStatus(row,'wait', statSpan);
    let filledQty = 0;
    for (let i=0;i<180;i++){ // 180 * 1s = 3 dk
      await new Promise(r=>setTimeout(r, 1000));
      const st = await proxyGET('/trade/order/status?symbol='+row.symbol+'&orderId='+row.activeOrderId);
      if (st.status==='FILLED'){
        filledQty = parseFloat(st.executedQty);
        break;
      } else if (st.status==='CANCELED' || st.status==='REJECTED' || st.status==='EXPIRED'){
        throw new Error('Alım tamamlanmadı: '+st.status);
      }
    }
    if (!filledQty) throw new Error('Zaman aşımı: Alım dolmadı');

    row.buyFilledQty = floorToStep(filledQty, row.info.stepSize);

    // 5) Satış: ASK M snapshot fiyatıyla LIMIT
    setStatus(row,'selling', statSpan);
    const sellRounded = roundPriceToTick(sellPriceSnap, row.info.tickSize);
    const sellRes = await proxyPOST('/trade/order', {
      symbol: row.symbol, side:'SELL', type:'LIMIT', timeInForce:'GTC',
      quantity: row.buyFilledQty.toString(), price: sellRounded.toString(),
      clientOrderId: 'S'+Date.now()
    });

    // 6) Bitti
    setStatus(row,'done', statSpan);
  }catch(e){
    console.error(e);
    setStatus(row,'error', statSpan);
  }finally{
    row.activeOrderId = null;
    save();
  }
}

function startRow(idx, statSpan){
  const row = S.rows[idx];
  if (row.running) return;
  row.running = true; save();
  el('globalStatus').textContent = 'Çalışıyor';
  // Döngü: bir cycle tamamlandıktan sonra 2 sn bekleyip tekrar (tek aktif emir akışı)
  const loop = async ()=>{
    if (!row.running) return;
    setStatus(row,'idle', statSpan);
    await oneCycle(idx, statSpan);
    if (!row.running) return;
    setTimeout(loop, 2000);
  };
  timers.set(idx, true);
  loop();
}
function stopRow(idx, statSpan){
  const row = S.rows[idx];
  row.running = false;
  setStatus(row,'idle', statSpan);
  timers.delete(idx);
  save();
  if ([...timers.keys()].length===0) el('globalStatus').textContent = 'Hazır';
}
</script>
</body>
</html>
